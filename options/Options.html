<div class="wrap">
    <h2> <?= $optionsheader; ?> </h2>
    <form class="autorization_manager" method="post" action="<?= $optionsaction; ?>">
        <input type="hidden" name="<?= $hidden_field_name; ?>" value="Y">
        <p>
            <?= $optionsapikey; ?> 
            <input type="text" name="<?= $apikey_field_name; ?>" value="<?= $opt_api_key; ?>" size="50">
        </p>
        <p>
            <input type="submit" name="oauthaut" value="Authorize and get API Key" <?= $unhaveapikey; ?>/>
        </p>
        <hr />
        <p class="submit">
            <input type="submit" name="Submit" value="<?= $optionsupdate; ?>" />
        </p>
    </form>
    <form class="user_file_manager" enctype="multipart/form-data" method="post" action="<?= $optionsaction; ?>" <?= $haveapikey; ?>>
        <input class="my_file_operation" type="hidden" name="my_file_operation" value="">
        <?= $servicefilelist; ?>
        <input class="file_input_text" type="file" name="my_file_upload" style="display: none">
        <input class="uploadbutton"type="button" value="<?= FileOperations::Upload; ?>" />
        <input class="downloadbutton" type="button" value="<?= FileOperations::Download; ?>" />
        <input class="renamebutton" type="button" value="<?= FileOperations::Rename; ?>" />
        <input class="deletebutton" type="button" value="<?= FileOperations::Delete; ?>" />
        <dialog class="renamedialog" >
            <label class="existtext"  style="color:#f00; display:none">File with this name already exist.</label><br />
            <input class="file_new_name" type="text" name="newfilename">
            <button class="closedg">Rename</button>
            <button class="canceldg">Cancel</button>
        </dialog>
        <script type="text/javascript">
            jQuery(function ($) {
                $('.wrap').on('click', '.uploadbutton', fileselect);
                $('.wrap').on('click', '.downloadbutton', download);
                $('.wrap').on('click', '.renamebutton', rename);
                $('.wrap').on('click', '.deletebutton', deleteclk);
                $('.wrap').on('change', '.file_input_text', upload);

                if ("<?= $continueoperation ?>" == "<?= FileOperations::ContinueDownload; ?>")
                    enddownload();

                function fileselect() {
                    $('.file_input_text').click();
                }
                function upload() {
                    $('.my_file_operation').val("<?= FileOperations::Upload; ?>");
                    $('.user_file_manager').submit();
                }
                function download() {
                    $('.my_file_operation').val("<?= FileOperations::Download; ?>");
                    $('.user_file_manager').submit();
                }
                function rename() {
                    var filearray = $('.filename').val().split('.');
                    var renamedfilename = filearray[0];
                    var fileextension = filearray[1];
                    var dialog = $('.renamedialog')[0];
                    $('.file_new_name').val(renamedfilename);
                    dialog.show();

                    $('.closedg').click(function () {
                        var filenotexists = true;
                        var newfilename = $('.file_new_name').val() + '.' + fileextension;
                        $('.filename option').each(function (index, element) {
                            if ($(element).text() == newfilename) {
                                $('.existtext').show();
                                filenotexists = false;
                                return;
                            }
                        });
                        if (filenotexists) {
                            dialog.close();
                            $('.file_new_name').val(newfilename);
                            $('.my_file_operation').val("<?= FileOperations::Rename; ?>");
                            $('.user_file_manager').submit();
                        }
                        else {
                            return;
                        }
                    });
                    document.querySelector('.canceldg').onclick = function () {
                        dialog.close();
                    };

                }
                function deleteclk() {
                    $('.my_file_operation').val("<?= FileOperations::Delete; ?>");
                    $('.user_file_manager').submit();
                }
                function enddownload() {
                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:application/octet-stream; charset=utf-8; base64,' + '<?= $downloadfile; ?>');
                    element.setAttribute('download', "<?= $filename; ?>");
                    element.click();
                    document.body.removeChild(element);
                }
            })
        </script>
    </form>
</div>